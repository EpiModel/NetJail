---
title: "Step7-JailTurnover"
author: "Karina Wallrafen-Sam"
date: "4/1/2022"
output: html_document
---

```{r}
turnover_rates <- data.frame(Category = rows, Admissions=NA, Releases=NA, 
                             AveragePop = NA, TurnoverIn = NA, TurnoverOut = NA)

#OVERALL
#Calculate # of new admissions (including repeat admissions)
admissions <- sum(activeDays$onset > -Inf)
turnover_rates[turnover_rates$Category == "Overall", ]$Admissions <- admissions

#Calculate # of releases
releases <- sum(activeDays$terminus < Inf)
turnover_rates[turnover_rates$Category == "Overall", ]$Releases <- releases

#Find average daily population
turnover_rates[turnover_rates$Category == "Overall", ]$AveragePop <- avg_pop
remove(admissions, releases)

#BY RACE
activeDays_race <- merge(activeDays, ids[ , c("id", "Race")], by = "id")
activeDays_race[activeDays_race$Race != "White" & 
                  activeDays_race$Race != "Black", ]$Race <- "Other"
for (i in seq_along(allRaces)) {
  admissions <- sum(activeDays_race$Race == allRaces[i] & 
                      activeDays_race$onset > -Inf)
  releases <- sum(activeDays_race$Race == allRaces[i] & 
                      activeDays_race$terminus < Inf)
  avg_pop <- mean(colSums(cDegDists_race[cDegDists_race$race == 
                                           allRaces[i],-c(1,2)], na.rm = TRUE))
  turnover_rates[turnover_rates$Category == allRaces[i], ]$Admissions <- 
    admissions
  turnover_rates[turnover_rates$Category == allRaces[i], ]$Releases <- releases
  turnover_rates[turnover_rates$Category == allRaces[i], ]$AveragePop <- avg_pop
}
remove(admissions, releases)

#BY AGE
activeDays_age <- merge(activeDays, ids[ , c("id", "InitialAge")], by = "id")
activeDays_age$InitialAge <- cut(activeDays_age$InitialAge, 
                                 breaks=c(0, 20, 30, 40, 50, 60, 100), 
                                 right = FALSE, 
                                 labels = c("Under 20", "20 - 29", "30 - 39", 
                                            "40 - 49", "50 - 59", "60+"))
 for (i in seq_along(allAges)) {
  admissions <- sum(activeDays_age$InitialAge == allAges[i] & 
                      activeDays_age$onset > -Inf)
  releases <- sum(activeDays_age$InitialAge == allAges[i] & 
                      activeDays_age$terminus < Inf)
  avg_pop <- mean(colSums(cDegDists_age[cDegDists_age$age == 
                                           allAges[i],-c(1,2)], na.rm = TRUE))
  turnover_rates[turnover_rates$Category == 
                   paste("Age", allAges[i], sep=" "), ]$Admissions <- admissions
  turnover_rates[turnover_rates$Category == 
                   paste("Age", allAges[i], sep=" "), ]$Releases <- releases
  turnover_rates[turnover_rates$Category == 
                   paste("Age", allAges[i], sep=" "), ]$AveragePop <- avg_pop
}
remove(admissions, releases, avg_pop)

#BY FLOOR
#Calculate admissions by floor
admissions_f <- activeDays[activeDays$onset > -Inf, c("id", "onset") ]
admissions_f <- merge(admissions_f, dates[, c("Date", "DayNum")], 
                    by.x = "onset", by.y = "DayNum")[, c("id", "Date")]
admissions_f <- merge(admissions_f, cDailyLoc, by = c("id", "Date"))
admissions_f$loc <- substr(admissions_f$loc, 0, 1)
admissions_f <- admissions_f %>% group_by(loc) %>% summarise(admissions = n())
turnover_rates[grepl("Floor", turnover_rates$Category), ]$Admissions <- 
  admissions_f$admissions
remove(admissions_f)

#Calculate releases by floor
releases_f <- activeDays[activeDays$terminus < Inf, c("id", "terminus") ]
releases_f$lastDay <- releases_f$terminus - 1 
releases_f <- merge(releases_f, dates[, c("Date", "DayNum")], 
                    by.x = "lastDay", by.y = "DayNum")[, c("id", "Date")]
releases_f <- merge(releases_f, cDailyLoc, by = c("id", "Date"))
releases_f$loc <- substr(releases_f$loc, 0, 1)
releases_f <- releases_f %>% group_by(loc) %>% summarise(releases = n())
turnover_rates[grepl("Floor", turnover_rates$Category), ]$Releases <- 
  releases_f$releases
remove(releases_f)

#Calculate average population size by floor
for (i in seq_along(allFloors)){
  avg_pop <- mean(colSums(cDegDists_floor[cDegDists_floor$floor == allFloors[i], 
                                          -c(1,2)], na.rm = TRUE))
  turnover_rates[turnover_rates$Category == 
                   paste("Floor", allFloors[i], sep=" "), ]$AveragePop <- 
    avg_pop
}
remove(avg_pop)

#Calculate turnover rates and print
turnover_rates$TurnoverIn <- (turnover_rates$Admissions / 
                                turnover_rates$AveragePop) / max(dates$DayNum) 
turnover_rates$TurnoverOut <- (turnover_rates$Releases / 
                                turnover_rates$AveragePop) / max(dates$DayNum) 
print(turnover_rates[ ,c("Category", "TurnoverOut")])







#Another approach to estimating avg. duration in network...
if (EstimateDurations == TRUE) {
  durations <- merge(cDailyLoc, dates, by = "Date")
  durations <- durations[with(durations, order(id, DayIndex)), ]
  ind <- which(durations$id==lag(durations$id) &
                 durations$DayIndex == (lag(durations$DayIndex) + 1))
  durations$newStay <- "True"
  durations[ind, ]$newStay <- "False"
  durations$stayCounter <- cumsum(durations$newStay == "True")
  durations$newStay <- NULL
  ind2 <- which(durations$stayCounter==lag(durations$stayCounter) &
                  durations$loc == lag(durations$loc))
  durations$newLoc <- "True"
  durations[ind2, ]$newLoc <- "False"
  durations$locCounter <- cumsum(durations$newLoc == "True")
  durations$newLoc <- NULL
  remove(ind, ind2)
  durations <- durations %>% group_by(stayCounter) %>%
    summarise(id = first(id), firstDay = min(DayNum), lastDay = max(DayNum), 
              numLocs = n_distinct(locCounter))
  durations$stayCounter <- NULL
  durations$duration <- durations$lastDay - durations$firstDay + 1
  durations$startCensored <- "N"
  durations$startCensored[durations$firstDay == 
                            min(durations$firstDay) ] <- "Y"
  durations$endCensored <- "N"
  durations$endCensored[durations$lastDay == 
                          max(durations$lastDay) ] <- "Y"
  durations <- merge(durations, ids[ , c("id", "Race", "InitialAge")], 
                     by = "id")
  durations[durations$Race != "White" & durations$Race != "Black", ]$Race <- 
    "Other"
  durations$InitialAge <- cut(durations$InitialAge, 
                              breaks=c(0, 20, 30, 40, 50, 60, 100), 
                              right = FALSE, labels = c("Under 20", "20 - 29", 
                                                        "30 - 39", "40 - 49", 
                                                        "50 - 59", "60+"))
  durations <- merge(durations, dates[, c("Date", "DayNum")], 
                     by.x = "firstDay", by.y = "DayNum")
  durations <- merge(durations, cDailyLoc, by = c("id", "Date"))
  durations$InitialFloor <- substr(durations$loc, 0, 1)
  
  durations1 <- durations %>% group_by(startCensored, endCensored) %>%
    summarise(category = "Overall", meanDur = mean(duration), numSpells = n(), 
              meanNumLocs = mean(numLocs))
  
  durations2 <- durations %>% 
    group_by(startCensored, endCensored, InitialFloor) %>% 
    summarise(meanDur = mean(duration), numSpells = n(), 
              meanNumLocs = mean(numLocs))
  durations2$InitialFloor <- paste("Floor", durations2$InitialFloor)
  names(durations2)[names(durations2) == "InitialFloor"] <- 'category'
  
  durations3 <- durations %>% group_by(startCensored, endCensored, Race) %>% 
    summarise(meanDur = mean(duration), numSpells = n(), 
              meanNumLocs = mean(numLocs))
  durations3$Race <- paste("Race", durations3$Race)
  names(durations3)[names(durations3) == 'Race'] <- 'category'
  
  durations4 <- durations %>% 
    group_by(startCensored, endCensored, InitialAge) %>% 
    summarise(meanDur = mean(duration), numSpells = n(), 
              meanNumLocs = mean(numLocs))
  durations4$InitialAge <- paste("Age", durations4$InitialAge)
  names(durations4)[names(durations4) == 'InitialAge'] <- 'category'
  
  durationsSummary <- rbind(durations1, durations2, durations3, durations4)
  durationsSummary <- durationsSummary[with(durationsSummary, order(category)),]
  durationsSummary <- durationsSummary %>% group_by(category) %>%
    mutate(percentSpells = round(numSpells / sum(numSpells), 4) * 100) 
  durationsSummary$meanDur <- round(durationsSummary$meanDur, 2)
  durationsSummary$meanNumLocs <- round(durationsSummary$meanNumLocs, 2)
  print.data.frame(durationsSummary[durationsSummary$category == "Overall",
                                    c("startCensored", "endCensored", "category", 
                                      "meanDur", "meanNumLocs", 
                                      "percentSpells")])
  
  remove(durations1, durations2, durations3, durations4)
}
```
